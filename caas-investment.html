<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../caas-campaign/caas-campaign.html">
<link rel="import" href="../caas-campaign-incentives/caas-campaign-incentives.html">

<!--
`caas-investment`
Polymer Investment Element for Crowdfunding as a Service Solutions

@demo demo/index.html 
-->

<dom-module id="caas-investment">
  <template>

    <caas-campaign
      api-endpoint="[[apiEndpoint]]"
      campaign-id="[[campaignId]]"
      contract-types="{{availableContractTypes}}"
    ></caas-campaign>

    <caas-campaign-incentives
      api-endpoint="[[apiEndpoint]]"
      campaign-id="[[campaignId]]"
      grouped-incentives="{{_apiIncentives}}"
    ></caas-campaign-incentives>

    <iron-ajax
      id="getTransactionCosts"
      url="[[apiEndpoint]]/buckaroo/transactioncosts"
      handle-as="json"
      method="GET"
      last-response="{{_transactionCostsData}}"
      debounce-duration="3000"
    ></iron-ajax>

    <iron-ajax
      id="getDraftContract"
      url="[[apiEndpoint]]/investors/[[investorId]]/draftcontract"
      handle-as="json"
      headers="[[_requestHeaders]]"
      body="[[_contractRequestData]]"
      method="POST"
      last-response="{{_draftContractData}}"
      on-response="_handleGetContractResponse"
      on-error="_handleGetContractError"
      debounce-duration="3000"
    ></iron-ajax>

    <iron-ajax
      id="getSignature"
      url="[[apiEndpoint]]/buckaroo/signature"
      handle-as="json"
      content-type="json"
      headers="[[_requestHeaders]]"
      body="[[_signatureRequestData]]"
      method="POST"
      last-response="{{_signatureData}}"
      on-response="_handleGetSignatureResponse"
      on-error="_handleGetSignatureError"
      debounce-duration="3000"
      auto="[[bic]]"
    ></iron-ajax>

    <form
      id="checkoutForm"
      action="[[checkoutUrl]]"
      method="POST"
    >
    <input  
    type="hidden"                
    readonly
    name="Add_userId"  
    value="[[_signatureData.userId]]">
    <input  
    type="hidden"                
    readonly
    name="Add_campaignId"  
    value="[[_signatureData.campaignId]]">
    <input  
    type="hidden"                
    readonly
    name="Add_contractTypeId"  
    value="[[_signatureData.contractTypeId]]">
    <input
    type="hidden"                
    readonly
    name="Add_incentiveId"  
    value="[[_signatureData.incentiveId]]">
    <input  
    type="hidden"                
    readonly 
    name="Brq_amount"  
    value="[[_signatureData.amount]]">
    <input  
    type="hidden"                
    readonly 
    name="Brq_currency"  
    value="[[_signatureData.currency]]">
    <input  
    type="hidden"                
    readonly 
    name="Brq_description"  
    value="[[_signatureData.description]]">
    <input  
    type="hidden"                
    readonly 
    name="Brq_invoicenumber"  
    value="[[_signatureData.invoiceNumber]]">
    <input  
    type="hidden"                
    readonly 
    name="Brq_PAYMENT_METHOD"  
    value="[[_signatureData.paymentMethod]]">
    <input  
    type="hidden"                
    readonly 
    name="Brq_return"  
    value="[[successCallbackUrl]]">
    <input  
    type="hidden"                
    readonly 
    name="Brq_returncancel"  
    value="[[cancelCallbackUrl]]">
    <input  
    type="hidden"                
    readonly 
    name="Brq_returnerror"  
    value="[[errorCallbackUrl]]">
    <input  
    type="hidden"                
    readonly 
    name="Brq_returnreject"  
    value="[[rejectCallbackUrl]]">
    <input  
    type="hidden"                
    readonly 
    name="Brq_SERVICE_ideal_action"  
    value="[[_signatureData.iDEALAction]]">
    <input  
    type="hidden"                
    readonly 
    name="Brq_SERVICE_ideal_issuer"  
    value="[[_signatureData.iDEALIssuer]]">
    <input  
    type="hidden"                
    readonly 
    name="Brq_SERVICE_ideal_version"  
    value="[[_signatureData.iDEALVersion]]">
    <input  
    type="hidden"                
    readonly 
    name="Brq_websitekey"  
    value="{{_signatureData.websiteKey}}">
    <input  
    type="hidden"                
    readonly 
    name="Brq_signature"  
    value="{{_signatureData.signature}}">
    </form>

  </template>

  <script>
    Polymer({

      is: 'caas-investment',

      properties: {

        /**
        * Exposes the server side API endpoint
        */
        apiEndpoint: {
          type: String,
          notify: true
        },

        campaignId: {
          type: String
        },

        contractTypeId: {
          type: String
        },

        amount: {
          type: Number
        },

        smallestAllowedAmount: {
          type: Number,
          computed: '_computeSmallestAllowedAmount(contractTypeId, availableContractTypes.*)',
          notify: true
        },

        largestAllowedAmount: {
          type: Number,
          computed: '_computeLargestAllowedAmount(contractTypeId, availableContractTypes.*)',
          notify: true
        },

        amountStep: {
          type: Number,
          computed: '_computeAmountStep(contractTypeId, availableContractTypes.*)',
          notify: true
        },

        incentiveId: {
          type: String
        },

        accessToken: {
          type: String
        },

        investorId: {
          type: String
        },

        userQualified: {
          type: Boolean,
          value: false,
          readOnly: true,
          notify: true
        },

        considerations: {
          type: Array,
          computed: '_computeConsiderations(apiEndpoint, campaignId, contractTypeId, amount, incentiveId, accessToken, transactionCosts)',
          notify: true
        },

        considerationsAccepted: {
          type: Boolean,
          notify: true,
          observer: '_handleConsiderationsAcceptedChanged'
        },

        contractAccepted: {
          type: Boolean,
          notify: true
        },

        termsOfUseAccepted: {
          type: Boolean,
          notify: true
        },

        checkoutUrl: {
          type: String,
          value: null
        },

        transactionCosts: {
          type: Number,
          notify: true,
          computed: '_computeTransactionCosts(_transactionCostsData.transactionCosts)',
        },

        availableContractTypes: {
          type: Array,
          value: null,
          notify: true
        },

        availableIncentives: {
          type: Array,
          value: null,
          computed: '_computeAvailableIncentives(_apiIncentives.*, contractTypeId)',
          notify: true
        },

        bic: {
          type: String
        },

        availableBanks: {
          type: Array,
          value: [
            {
              name: "ABN AMRO Bank",
              bic: "ABNANL2A"
            },
            {
              name: "ASN Bank",
              bic: "ASNBNL21"
            },
            {
              name: "Bunq bank",
              bic: "BUNQNL2A"
            },
            {
              name: "ING Bank",
              bic: "INGBNL2A"
            },
            {
              name: "Knab",
              bic: "KNABNL2H"
            },
            {
              name: "Rabobank",
              bic: "RABONL2U"
            },
            {
              name: "RegioBank",
              bic: "RBRBNL21"
            },
            {
              name: "SNS bank",
              bic: "SNSBNL2A"
            },
            {
              name: "Triodos Bank",
              bic: "TRIONL2U"
            },
            {
              name: "Van Lanschot",
              bic: "FVLBNL22"
            }
          ],
          notify: true
        },

        checkoutUrl: {
          type: String,
          value: 'https://testcheckout.buckaroo.nl/html/'
        },

        successCallbackUrl: {
          type: String
        },

        cancelCallbackUrl: {
          type: String
        },

        errorCallbackUrl: {
          type: String
        },

        rejectCallbackUrl: {
          type: String
        },

        checkoutAllowed: {
          type: Boolean,
          value: false,
          computed: '_computeCheckoutAllowed(_signatureData.signature, considerationsAccepted, contractAccepted)',
          notify: true
        },

        draftContract: {
          type: String,
          computed: '_computeDraftContract(_draftContractData.body, considerationsAccepted)',
          notify: true
        },

        _signatureRequestData: {
          type: String,
          computed: '_computeSignatureRequestData(campaignId, incentiveId, contractTypeId, amount, bic, successCallbackUrl, cancelCallbackUrl, errorCallbackUrl, rejectCallbackUrl)'
        },

        _contractRequestData: {
          type: String,
          computed: '_computeContractRequestData(campaignId, incentiveId, contractTypeId, amount)'
        },

        _transactionCostsData: {
          type: Object,
          value: {}
        },

        _transactionSignature: {
          type: String,
          value: null
        },

        _campaignData: {
          type: Object,
        },

        _apiIncentives: {
          type: Object
        },

        _requestHeaders: {
          type: Object,
          computed: '_computeRequestHeaders(accessToken)'
        },

        _signatureData: {
          type: Object
        },

        _draftContractData: {
          type: String
        }

      },

      observers: [
        '_getTransactionCosts(apiEndpoint, campaignId, contractTypeId, amount, incentiveId, accessToken)',
        'getDraftContract(apiEndpoint, campaignId, contractTypeId, amount, incentiveId, accessToken, considerationsAccepted)',
        '_resetConsiderations(apiEndpoint, campaignId, contractTypeId, amount, incentiveId, accessToken)'
      ],

      checkout: function() {
        this.$.checkoutForm.submit();
      },

      getDraftContract: function() {
        this.$.getDraftContract.generateRequest();
      },

      _resetConsiderations: function(apiEndpoint, campaignId, contractTypeId, amount, incentiveId, accessToken) {
        this.considerationsAccepted = false;
      },

      _getTransactionCosts: function(apiEndpoint, campaignId, contractTypeId, amount, incentiveId, accessToken) {
        this.$.getTransactionCosts.generateRequest();
      },

      _computeRequestHeaders: function(accessToken) {
        return {
          'authorization': 'Bearer ' + accessToken 
        }
      },

      _computeSignatureRequestData: function(campaignId, incentiveId, contractTypeId, amount, bic, successCallbackUrl, cancelCallbackUrl, errorCallbackUrl, rejectCallbackUrl) {
        return JSON.stringify({
          "campaignId": campaignId,
          "incentiveId": incentiveId,
          "contractTypeId": contractTypeId,
          "amount": amount,
          "BIC": bic,
          "successCallbackUrl": successCallbackUrl,
          "cancelCallbackUrl": cancelCallbackUrl,
          "errorCallbackUrl": errorCallbackUrl,
          "rejectCallbackUrl": rejectCallbackUrl
        })
      },

      _computeContractRequestData: function(campaignId, incentiveId, contractTypeId, amount) {
        return JSON.stringify({
          "campaignId": campaignId,
          "incentiveId": incentiveId,
          "contractTypeId": contractTypeId,
          "amount": amount
        })
      },

      _computeAvailableIncentives: function(apiIncentives, contractTypeId) {
        return this._apiIncentives[contractTypeId];
      },

      _computeConsiderations: function(apiEndpoint, campaignId, contractTypeId, amount, incentiveId, accessToken, transactionCosts) {

        var considerations = [];

        // var one = '';

        switch(parseInt(contractTypeId)) {
          case 1:
          case 2:
            considerations = ['Je doet een vooraankoop. Omdat de levering vaak op langere termijn plaats vindt zijn er risico\'s bij een eventueel faillissement.'];
            break;
          default:
            considerations = [
              'Beleg een verantwoord deel van je vermogen. Investeer uitsluitend met geld dat je kunt missen.',
              'Spreid je beleggingen. Spreid je risico door in zo divers mogelijke projecten te investeren.',
              'Lees de volledige overeenkomst en bevestig onderaan dat je deze goed hebt gelezen. Pas daarna kun je investeren.'
            ]
            break;
        }

        considerations.splice(0, 0, 'Er gelden eenmalige transactiekosten van €' + transactionCosts + '. Je loopt het risico om je volledige inleg kwijt te raken, bijvoorbeeld in het geval van faillissement.');

        return considerations;

      },

      _computeCheckoutAllowed: function(signature, considerationsAccepted, contractAccepted) {
        return (!!signature && !!considerationsAccepted && !!contractAccepted);
      },

      _computeTransactionCosts: function(costs) {
        return costs;
      },

      _computeContractTypes: function(contractTypeIds) {
        return contractTypeIds;
      },

      _computeSmallestAllowedAmount: function(contractTypeId, contractTypesChange) {
        var contractTypes = contractTypesChange.base;
        var selectedContractType = contractTypes.filter(function(contractType) {
          return contractType.id == contractTypeId;
        })[0]
        return (selectedContractType) ? selectedContractType.smallestAllowedInvestment : null;
      },

      _computeLargestAllowedAmount: function(contractTypeId, contractTypesChange) {
        var contractTypes = contractTypesChange.base;
        var selectedContractType = contractTypes.filter(function(contractType) {
          return contractType.id == contractTypeId;
        })[0]
        return (selectedContractType) ? selectedContractType.largestAllowedInvestment : null;
      },

      _computeAmountStep: function(contractTypeId, contractTypesChange) {
        var contractTypes = contractTypesChange.base;
        var selectedContractType = contractTypes.filter(function(contractType) {
          return contractType.id == contractTypeId;
        })[0]
        return (selectedContractType) ? selectedContractType.investmentStep : null;
      },

      _computeDraftContract: function(draftContractBody, considerationsAccepted) {
        if(!considerationsAccepted) return '';
        return draftContractBody;
      },

      _handleConsiderationsAcceptedChanged: function(considerationsAccepted) {
        if(considerationsAccepted) this.fire('considerations-accepted');
        else this.fire('considerations-unaccepted');
        this.fire('considerations-acceptance-changed', considerationsAccepted);
        this.contractAccepted = false;
      },

      _handleGetSignatureResponse: function() {
        this.fire('investment-signed');
      },

      _handleGetSignatureError: function(evt) {
        this.fire('investment-sign-error', {
          message: evt.detail.error.message,
          response: event.detail.request.xhr.response
        });
      },

      _handleGetContractResponse: function() {
        this.fire('contract-drafted', this.draftContract);
      },

      _handleGetContractError: function(evt) {
        this.fire('contract-draft-error', {
          message: evt.detail.error.message,
          response: event.detail.request.xhr.response
        });
      }

    });
  </script>
</dom-module>
